name: build-and-deploy-asg

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  packages: write

jobs:
  build_deploy:
    runs-on: ubuntu-latest
    env:
      IMAGE_REPO: ghcr.io/suleyman-kutukoglu/auto-scaling-demo

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ghcr.io/suleyman-kutukoglu/auto-scaling-demo:sha-${{ github.sha }}
            ghcr.io/suleyman-kutukoglu/auto-scaling-demo:latest

      - name: Install AWS CLI (if missing)
        shell: bash
        run: |
          if ! command -v aws >/dev/null 2>&1; then
            curl -sS "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o awscliv2.zip
            unzip -q awscliv2.zip
            sudo ./aws/install
          fi
          aws --version

      - name: Deploy to ASG (LC + stop-the-world rollout)
        shell: bash
        env:
          ASG_ENDPOINT: ${{ secrets.ASG_ENDPOINT }}   # example: https://cloud-tr-03.rng.tech/api/v2/aws
          ASG_NAME:     ${{ secrets.ASG_NAME }}       # Auto-Scaling
          AMI_ID:       ${{ secrets.AMI_ID }}
          KEY_NAME:     ${{ secrets.KEY_NAME }}
          SECURITY_GROUP_ID: ${{ secrets.SECURITY_GROUP_ID }}
          INSTANCE_TYPE: ${{ secrets.INSTANCE_TYPE }}

          AWS_ACCESS_KEY_ID:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION:    ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          set -euo pipefail

          # IMPORTANT:
          # Your AWS-like endpoint must include /api/v2/aws (NOT /autoscaling at the end).
          # We call 'autoscaling' service path via the aws cli itself.
          awsa() { aws --endpoint-url "$ASG_ENDPOINT" "$@"; }

          IMAGE_SHA="${IMAGE_REPO}:sha-${GITHUB_SHA}"

          echo "Endpoint: $ASG_ENDPOINT"
          echo "ASG: $ASG_NAME"
          echo "Image: $IMAGE_SHA"

          # 1) Generate RAW cloud-init (NO base64!)
          cat > cloudinit.yml <<EOF
          #cloud-config
          write_files:
            - path: /usr/local/bin/run-app.sh
              permissions: "0755"
              owner: root:root
              content: |
                #!/bin/bash
                set -euo pipefail

                systemctl enable --now docker

                IMAGE="$IMAGE_SHA"

                # retry/backoff for flaky network pulls
                for i in 1 2 3 4 5; do
                  docker pull "\$IMAGE" && break
                  echo "docker pull failed (attempt \$i) - sleeping..." >&2
                  sleep \$((i*5))
                done

                docker rm -f asg-demo >/dev/null 2>&1 || true
                docker run -d --name asg-demo --restart unless-stopped -p 80:80 "\$IMAGE"
          runcmd:
            - [ bash, -lc, /usr/local/bin/run-app.sh ]
          EOF

          # 2) Create LC for this commit
          LC="auto-scale-demo-${GITHUB_SHA:0:8}"
          echo "Creating Launch Configuration: $LC"

          awsa autoscaling create-launch-configuration \
            --launch-configuration-name "$LC" \
            --image-id "$AMI_ID" \
            --key-name "$KEY_NAME" \
            --security-groups "$SECURITY_GROUP_ID" \
            --instance-type "$INSTANCE_TYPE" \
            --user-data file://cloudinit.yml

          # 3) Stop-the-world rollout: scale down to 0 (terminate all), but also point ASG to new LC
          echo "Scaling down to 0 (stop-the-world)..."
          awsa autoscaling update-auto-scaling-group \
            --auto-scaling-group-name "$ASG_NAME" \
            --launch-configuration-name "$LC" \
            --min-size 0 \
            --desired-capacity 0

          echo "Waiting until ASG has 0 instances..."
          for _ in {1..90}; do
            COUNT="$(awsa autoscaling describe-auto-scaling-groups \
              --auto-scaling-group-names "$ASG_NAME" \
              --query 'AutoScalingGroups[0].Instances | length(@)' \
              --output text)"
            echo "Instance count: $COUNT"
            [ "$COUNT" = "0" ] && break
            sleep 5
          done

          # Hard fail if couldn't drain to 0
          COUNT="$(awsa autoscaling describe-auto-scaling-groups \
            --auto-scaling-group-names "$ASG_NAME" \
            --query 'AutoScalingGroups[0].Instances | length(@)' \
            --output text)"
          [ "$COUNT" = "0" ] || { echo "❌ Still not 0 instances"; exit 1; }

          # 4) Scale up to 1
          echo "Scaling up to 1 with new LC..."
          awsa autoscaling update-auto-scaling-group \
            --auto-scaling-group-name "$ASG_NAME" \
            --launch-configuration-name "$LC" \
            --min-size 1 \
            --desired-capacity 1

          # 5) Wait for new instance using this LC
          echo "Waiting for 1 Healthy/InService instance with LC=$LC ..."
          for _ in {1..120}; do
            OUT="$(awsa autoscaling describe-auto-scaling-groups \
              --auto-scaling-group-names "$ASG_NAME" \
              --query "AutoScalingGroups[0].Instances[?LaunchConfigurationName=='$LC'].[InstanceId,LifecycleState,HealthStatus] | [0]" \
              --output text || true)"

            echo "Candidate: $OUT"
            if echo "$OUT" | grep -qE '^i-'; then
              STATE="$(echo "$OUT" | awk '{print $2}')"
              HEALTH="$(echo "$OUT" | awk '{print $3}')"
              if [ "$STATE" = "InService" ] && [ "$HEALTH" = "Healthy" ]; then
                echo "✅ Deployed: $OUT"
                exit 0
              fi
            fi
            sleep 5
          done

          echo "❌ Timeout waiting for Healthy/InService instance on LC=$LC"
          echo "ASG dump:"
          awsa autoscaling describe-auto-scaling-groups --auto-scaling-group-names "$ASG_NAME"
          exit 1
